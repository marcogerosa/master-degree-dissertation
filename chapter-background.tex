% -*- root: dissertacao.tex -*-
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\setlength{\parindent}{20pt}
\setlength{\textheight}{22cm}
\setlength{\parskip}{0.2cm}
\linespread{1.2} % Para aumentar o espaçamento entre as linhas
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Fundamentação Conceitual}
\label{cap:background}

Para a compreensão deste trabalho é importante ter claro a definição de 3 itens, são eles: Qualidade de Código, \textit{Code Smells} e \textit{Android}.

\section{Qualidade de Código}


\section{Code Smells}

Mau cheiro de código é uma indicação superficial que usualmente corresponde a um problema mais profundo em um software. Por si só um \textit{code smell}, seu termo em inglês, não é algo ruim, ocorre que frequentemente ele indica um problema mas não necessáriamente é o problema em si \cite{CodeSmell:06}. O termo em inglês \textit{code smell} foi cunhado pela primeira vez por Kent Beck enquanto ajudava Martin Fowler com o seu livro Refactoring \cite{Refactoring:99} \cite{CodeSmell:06}.

Maus cheiros são padrões de código que estão associados com um design ruim e más práticas de programação. Diferentemente de erros de código eles não resultam em comportamentos erroneos. Maus cheiros apontam para áreas na aplicação que podem se beneficiar de refatorações. \cite{MobileSmells:13}. Refatoração é definido por ``uma técnica para reestruturação de um código existente, alterando sua estrutura interna sem alterar seu comportamento externo'' \cite{Refactoring:99}.

Escolher não resolver um mau cheiro pela refatoração não resultará na aplicação falhar mas irá aumentar a dificuldade de mantê-la. Logo, a refatoração ajuda a melhorar a manutenabilidade de uma aplicação \cite{MobileSmells:13}. Uma vez que os custos com manutenção são a maior parte dos custos envolvidos no ciclo de desenvolvimento de software \cite{RefactoringAndImprovements:10}, aumentar a manutenabilidade através de refatoração irá reduzir os custos de um software no longo prazo. 

\section{Android}
\label{sec:Android}

\subsection{Arquitetura da Plataforma}

Android é um sistema operacional de código aberto, baseado no kernel do Linux criado para um amplo conjunto de dispositivos. Para prover acesso aos recursos específicos dos dispositivos como câmera ou \textit{bluetooth}, o Android possui uma camada de abstração de \textit{hardware} (HAL do inglês \textit{Hardware Abstraction Layer}) exposto aos desenvolvedores através de um arcabouço de interfaces de programação de aplicativos (APIs do inglês \textit{Applications Programming Interface}) Java. Estes e outros elementos explicados a seguir podem ser visualizados na figura \ref{fig:AndroidPlatform} \cite{AndroidPlatformArchitecture}.

\begin{figure}[!htb]
	\centering
	\includegraphics[width=0.7\textwidth]{android-architecture.png}
	\caption{Arquitetura do sistema operacional Android.}
	\label{fig:AndroidPlatform}
\end{figure}

Cada aplicativo é executado em um novo processo de sistema que contém sua própria instância do ambiente de execução Android. A partir da versão 5 (API nível 21), o ambiente de execução padrão é o Android Runtime (ART), antes desta versão era a Dalvik. ART foi escrita para executar multiplas instâncias de máquina virtual em dispositivos com pouca memória. Suas funcionalidades incluem duas forma de compilação: a frente do tempo (AOT do inglês \textit{Ahead-of-time}) e apenas no momento (JIT do inglês \textit{Just-in-time}), o coletor de lixo, ferramentas de depuração e um relatório de diagnósticos de erros e exceções.

Muitos dos componentes e serviços básicos do Android, como ART e HAL, foram criados a partir de código nativo que depende de bibliotecas nativas escritas em C e C++. A plataforma Android provê arcabouços de APIs Java para expôr as funcionalidade de algumas destas bibliotecas nativas para os aplicativos. Por exemplo, OpenGL ES pode ser acessado através do arcabouço Android Java OpenGL API, de forma a adicionar suporte ao desenho e manipulação de gráficos 2D e 3D no aplicativo.

Todo as funcionalidades da plataforma Android estão disponíveis para os aplicativos através de APIs Java. Estas APIs compõem os elementos básicos para a construção de aplicativos Android. Dentre eles, os mais relevantes para esta dissertação são:

\begin{itemize}
	\item Um rico e extensível \textbf{Sistema de Visualização} para a contrução de interfaces com o usuário, também chamadas de arquivos de \textit{layout}, do aplicativo. Incluindo listas, grades, caixas de textos, botões, dentre outros.

	\item Um \textbf{Gerenciador de Recursos}, provendo acesso aos recursos ``não-java'' como textos, elementos gráficos, arquivos de \textit{layout}.

	\item Um \textbf{Gerenciador de Activity} que gerencia o ciclo de vida dos aplicativos e provê uma navegação comum.
\end{itemize}

O Android já vem com um conjunto de aplicativos básicos como por exemplo, para envio e recebimento de SMS, calendário, navegador, contatos e outros. Estes aplicativos vindos com a plataforma não possuem nenhum diferencial com relação aos aplicativos de terceiros. Todo aplicativo tem acesso ao mesmo arcabouço de APIs do Android, seja ele aplicativo da plataforma ou de terceiro. Desta forma, um aplicativo de terceiro pode se tornar o aplicativo padrão para navegar na internet, receber e enviar SMS e assim por diante.

Aplicativos da plataforma provem capacidades básicas que aplicativos de terceiros podem reutilizar. Por exemplo, se um aplicativo de terceiro quer possibilitar o envio de SMS, o mesmo pode redirecionar esta funcionalidade de forma a abrir o aplicativo de SMS já existente, ao invés de implementar por si só.

\subsection{Aplicativos Android}

Aplicativos Android são escritos na linguagem de programação Java. O Kit para Desenvolvimento de Software (SDK do inglês \textit{Software Development Kit}) Android compila o código, junto com qualquer arquivo de recurso ou dados, em um arquivo Android Package (APK). Um APK, arquivo com extensão \texttt{.apk}, é usado por dispositivos para a instalação de um aplicativo \cite{AndroidFundamentals}.

Componentes Android são os elementos base para a construção de aplicativos Android. Cada componente é um diferente ponto através do qual o sistema pode acionar o aplicativo. Nem todos os componente são pontos de entrada para o usuário e alguns são dependentes entre si, mas cada qual existe de forma autônoma e desempenha um papel específico. 

Existem quatro tipos diferentes de componentes Android. Cada tipo serve um propósito distinto e tem diferentes ciclos de vida, que definem como o componente é criado e destruído. Os quatro componentes são:

\begin{itemize}

	\item \textbf{Activities}

	Uma \textit{activity} representa uma tela com uma interface de usuário. Por exemplo, um aplicativo de email pode ter uma \textit{activity} para mostrar a lista de emails, outra para redigir um email, outra para ler emails e assim por diante. Embora \textit{activities} trabalhem juntas de forma a criar uma experiência de usuário (UX do inglês \textit{User Experience}) coesa no aplicativo de emails, cada uma é independente da outra. Desta forma, um aplicativo diferente poderia iniciar qualquer uma destas \textit{activities} (se o aplicativo de emails permitir). Por exemplo, a \textit{activity} de redigir email no aplicativo de emails, poderia solicitar o aplicativo câmera, de forma a permitir o compartilhamento de alguma foto. Uma \textit{activity} é implementada como uma subclasse de \texttt{Activity}.  

	\item \textbf{Services}

	Um \textit{service} é um componente que é executado em plano de fundo para processar operações de longa duração ou processar operações remotas. Um \textit{service} não provê uma interface com o usuário. Por exemplo, um \textit{service} pode tocar uma música em plano de fundo enquanto o usuário está usando um aplicativo diferente, ou ele pode buscar dados em um servidor remoto através da internet sem bloquear as interações do usuário com a \textit{activity}. Outros componente, como uma \textit{activity}, podem iniciar um \textit{service} e deixá-lo executar em plano de fundo. É possível interagir com um \textit{service} durante sua execução. Um \textit{service} é implementado como uma subclasse de \texttt{Service}.

	\item \textbf{Content Providers}

	Um \textit{content provider} gerencia um conjunto compartilhado de dados do aplicativo. Estes dados podem estar armazenados em arquivos de sistema, banco de dados SQLite, servidor remoto ou qualquer outro local de armazenamento que o aplicativo possa acessar. Através de \textit{content providers}, outros aplicativos podem consultar ou modificar (se o \textit{content provider} permitir) os dados. Por exemplo, a plataforma Android disponibiliza um \textit{content provider} que gerencia as informações dos contatos dos usuários. Desta forma, qualquer aplicativo, com as devidas permissões, pode consultar parte do \textit{content provider} (como \texttt{ContactsContract.Data}) para ler e escrever informações sobre um contato específico. Um \textit{content provider} é implementado como uma subclasse de \texttt{ContentProvider}.

	\item \textbf{Broadcast Receivers}

	Um \textit{broadcast receiver} é um componente que responde a mensagens enviadas pelo sistema. Muitas destas mensagens são originadas da plataforma Android, por exemplo, o desligamento da tela, baixo nível de bateria e assim por diante. Aplicativos de terceiros também podem enviar mensagens, por exemplo, informando que alguma operação foi concluída. No entanto, \textit{broadcast receivers} não possuem interface de usuário. Para informar o usuário que algo ocorreu, \textit{broadcast receivers} podem criar notificações. Um \textit{broadcast receiver} é implementado como uma subclasse de \texttt{BroadcastReceiver}.

\end{itemize}

Antes de a plataforma Android poder iniciar qualquer um dos componente supremencionados, a plataforma precisa saber que eles existem. Isso é feito através da leitura do arquivo \texttt{AndroidManifest.xml} do aplicativo (arquivo de manifesto). Este arquivo deve estar no diretório raiz do projeto do aplicativo e deve conter a declaração de todos os seus componentes.

O arquivo de manifesto é um arquivo XML e pode conter muitas outras informações além das declarações dos componentes do aplicativo, por exemplo:

\begin{itemize}
	\item Identificar qualquer permissão de usuário requerida pelo aplicativo, como acesso a internet, acesso a informações de contatos do usuário e assim por diante.

	\item Declarar o nível mínimo do Android requerido para o aplicativo, baseado em quais APIs são usadas pelo aplicativo.

	\item Declarar quais funcionalidades de sistema ou \textit{hardware} são usadas ou requeridas pelo aplicativo, por exemplo câmera, \textit{bluetooth} e assim por diante.

	\item Declarar outras APIs que são necessárias para uso do aplicativo (além do arcabouço de APIs do Android), como a biblioteca do Google Maps.
\end{itemize}

Os elementos usados no arquivo de manifesto são definidos pelo vocabulário XML do Android. Por exemplo, uma \textit{activity} pode ser declarada conforme o \textit{listing} \ref{lst:AndroidManifest}. \\

\begin{lstlisting}[
	language=XML, 
	caption={Arquivo \texttt{AndroidManifest.xml}}, 
	label={lst:AndroidManifest}
]
<?xml version="1.0" encoding="utf-8"?>
<manifest ... >
    <application android:icon="@drawable/app_icon.png" ... >
        <activity android:name="com.example.project.ExampleActivity"
                  android:label="@string/example_label" ... >
        </activity>
        ...
    </application>
</manifest>	
\end{lstlisting}

No elemento \texttt{<application>} o atributo \texttt{android:icon} aponta para o ícone, que é um recurso, que identifica o aplicativo. No elemento \texttt{<activity>}, o atributo \texttt{android:name} especifica o nome da classe completamente qualificado de uma subclasse de \texttt{Activity} e o atributo \texttt{android:label} especifica um texto para ser usado como título da atividade.

Para declarar cada um dos quatro tipos de componentes, deve-se usar os elementos a seguir:
\begin{itemize}
	\item \texttt{<activity>} elemento para \textit{activities}.
	\item \texttt{<service>} elemento para \textit{services}.
	\item \texttt{<receiver>} elemento para \textit{broadcast receivers}.
	\item \texttt{<provider>} elemento para \textit{content providers}.
\end{itemize}

\subsection{Recursos do Aplicativo}

Um aplicativo Android é composto por outros arquivos além de código Java, ele requer \textbf{recursos} como imagens, arquivos de áudio, e qualquer recurso relativo a apresentação visual do aplicativo \cite{AndroidFundamentals}. Também é possível definir animações, menus, estilos, cores e arquivos de \textit{layout} das \textit{activities}. Recursos costumam ser arquivos XML que usam o vocabulário definido pelo Android.

Um dos aspectos mais importantes de prover recursos separados do código-fonte é a habilidade de prover recursos alternativos para diferentes configurações de dispositivos como por exemplo idioma ou tamanho de tela. Este aspecto se torna mais importante conforme mais dispositivos são lançados com configurações diferentes. Segundo levantamento, em 2015 foram encontrados mais de 24 mil dispositivos diferentes com Android \cite{AndroidFragmentation}.

De forma a prover compatibilidade com diferentes configurações, deve-se organizar os recursos dentro do diretório \texttt{res} do projeto, usando sub-diretórios que agrupam os recursos por tipo e configuração. Para qualquer tipo de recurso, pode-se especificar uma opção padrão e outras alternativas. 

\begin{itemize}
	\item \textbf{Recursos padrões} são aqueles que devem ser usados independente de qualquer configuração ou quando não há um recurso alternativo que atenda a configuração atual. Por exemplo, arquivos de \textit{layout} padrão ficam em \texttt{res/layout}.

	\item \textbf{Recursos alternativos} são todos aqueles que foram desenhados para atender a uma configuração específica. Para especificar que um grupo de recursos é para ser usado em determinada configuração, basta adicionar um qualificador ao nome do diretório. Por exemplo, arquivos de \textit{layout} para quando o dispositivo está em posição de paisagem ficam em res/layout-land
\end{itemize}

O Android irá aplicar automaticamente o recurso apropriado através da identificação da configuração corrente do dispositivo com os recursos disponíveis no aplicativo. Por exemplo, o recurso do tipo \textit{strings} pode conter textos usados nas interfaces do aplicativo. É possível traduzir estes textos em diferentes idiomas e salvá-los em arquivos separados. Desta forma, baseado no qualificador de idioma usado no nome do diretório deste tipo de recurso (por exemplo \texttt{res/values-fr} para o idioma frânces) e a configuração de idioma do dispositivo, o Android aplica o conjunto de \textit{strings} mais apropriado.

A seguir são listados os tipos de recursos que podem ser utilizados no Android \cite{AndroidResourceType}. Para cada tipo de recurso existe um conjunto de qualificadores que podem ser usados para prover recursos alternativos:

\begin{itemize}
	\item \textbf{Recursos de animações} Definem animações pré-determinadas. Ficam nos diretórios \texttt{res/anim} ou \texttt{res/animator}.

	\item \textbf{Recursos de lista de cores de estado} Definem recursos de cores que alteram baseado no estado da \textit{View}. Ficam no diretório \texttt{res/color}.	

	\item \textbf{Recursos de desenhos} Definem recursos gráficos com \textit{bitmap} ou XML. Ficam no diretório \texttt{res/drawable}.

	\item \textbf{Recursos de \textit{layouts}} Definem a parte visual da interface com o usuário. Ficam no diretório \texttt{res/layout}.

	\item \textbf{Recursos de menus} Definem os conteúdos dos menus da aplicação. Ficam no diretório \texttt{res/menu}.

	\item \textbf{Recursos de textos} Definem textos, conjunto de textos e plurals. Ficam no diretório \texttt{res/values}.

	\item \textbf{Recursos de estilos} Definem os estilos e e formatos para os elementos da interface com usuário. Ficam no diretório \texttt{res/values}.

	\item \textbf{Outros recursos} Ainda existem outros recursos como inteiros, \textit{booleanos}, dimensões, dentre outros. Ficam no diretório \texttt{res/values}.
\end{itemize}

\subsection{Elementos da Camada de Apresentação}

Segundo a documentação do Android ``uma \textit{activity} é um componente de aplicação que representa uma tela com interface para o usuário onde o mesmo pode interagir para executar ações'' \cite{AndroidFundamentals}. Estas interações podem ser capturadas através da implementação de \textit{listeners}. Por se relacionar diretamente com o que é visto pelo usuário e pela forma de responder a ações do mesmo, tanto a \texttt{Activity} quanto os \textit{listeners}, foram considerados como parte da camada de apresentação.

Ainda segundo a documentação, ``recursos são imagens, arquivos de áudio, e \textbf{qualquer coisa relacionada a apresentação visual do aplicativo}'' (tradução livre). Apesar de ser possível criar estes mesmos elementos a partir de código Java, recomenda-se o uso de recursos, conforme explicado na seção \ref{sec:Android}. Por se relacionar diretamente com informações vistas pelo usuário, todo tipo de recurso, estando localizado no diretório \texttt{res} ou no seu formato Java, foi considerado como parte da camada de apresentação.

Um arquivo de \textit{layouts} é o tipo de recurso usado para a criação de interfaces com o usuário conforme detalhada na seção \ref{sec:Android}. E conforme visto, para apresentar coleção de dados não pré-determinados ou dinâmicas, utiliza-se uma \textit{view} que herde de \texttt{AdapterView} de forma a poder usar classes filhas de \texttt{Adapter} para realizar o carregamento de cada item da coleção, na \textit{view}. Desta forma, por \textit{adapters} fazerem o trabalho de colocar informações na tela, foi considerado também como elemento parte da camada de apresentação.
